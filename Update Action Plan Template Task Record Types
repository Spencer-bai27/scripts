// As of 11/26/2025 at 3:55PM in the full Sandbox, this successfully updated 4339 action plans and failed on 420 // Step 1: Update templates (should work fine)
List<LabsActionPlans__ActionPlanTemplate__c> lapt = [
    SELECT Id, Name, LabsActionPlans__TaskRecordTypeID__c 
    FROM LabsActionPlans__ActionPlanTemplate__c 
    WHERE Id IN (
        'a04Ua0000057kUgIAI',
        'a04Ua0000057lH5IAI',
        'a04Ua0000057nSXIAY',
        'a04Ua0000057nU9IAI',
        'a04Ua0000057nXNIAY',
        'a04Ua0000057nYzIAI',
        'a04Ua0000057nfRIAQ',
        'a04Ua0000057nh3IAA',
        'a04Ua0000057nkHIAQ',
        'a04Ua0000057nltIAA',
        'a04Ua000007xKwNIAU'
    )
];

for(LabsActionPlans__ActionPlanTemplate__c current : lapt) {
    current.LabsActionPlans__TaskRecordTypeID__c = '012VC000002mfNtYAI';
}
update lapt;

// Step 2: Update Action Plans with error handling
List<LabsActionPlans__ActionPlan__c> actionPlans = [
    SELECT Id, 
           LabsActionPlans__Action_Plan_Template__c, 
           LabsActionPlans__TaskRecordTypeID__c
    FROM LabsActionPlans__ActionPlan__c
    WHERE LabsActionPlans__Action_Plan_Template__c IN :lapt
];

System.debug('Found ' + actionPlans.size() + ' Action Plans to update');

for(LabsActionPlans__ActionPlan__c ap : actionPlans) {
    ap.LabsActionPlans__TaskRecordTypeID__c = '012VC000002mfNtYAI';
}

// Use Database.update with allOrNone = false to see which fail
Database.SaveResult[] results = Database.update(actionPlans, false);

Integer successCount = 0;
Integer failCount = 0;

for(Integer i = 0; i < results.size(); i++) {
    if(results[i].isSuccess()) {
        successCount++;
    } else {
        failCount++;
        System.debug('FAILED: Action Plan ' + actionPlans[i].Id);
        for(Database.Error err : results[i].getErrors()) {
            System.debug('Error: ' + err.getMessage());
            System.debug('Fields: ' + err.getFields());
        }
    }
}

System.debug('Success: ' + successCount + ', Failed: ' + failCount);





////////////
// Query the Action Plans related to your templates
List<LabsActionPlans__ActionPlanTemplate__c> lapt = [
    SELECT Id 
    FROM LabsActionPlans__ActionPlanTemplate__c 
    WHERE Id IN (
        'a04Ua0000057kUgIAI',
        'a04Ua0000057lH5IAI',
        'a04Ua0000057nSXIAY',
        'a04Ua0000057nU9IAI',
        'a04Ua0000057nXNIAY',
        'a04Ua0000057nYzIAI',
        'a04Ua0000057nfRIAQ',
        'a04Ua0000057nh3IAA',
        'a04Ua0000057nkHIAQ',
        'a04Ua0000057nltIAA',
        'a04Ua000007xKwNIAU'
    )
];

// Query all Action Plans with full relationship details
List<LabsActionPlans__ActionPlan__c> actionPlans = [
    SELECT Id,
           Name,
           LabsActionPlans__Action_Plan_Template__c,
           LabsActionPlans__Action_Plan_Template__r.Name,
           LabsActionPlans__TaskRecordTypeID__c,
           LabsActionPlans__Account__c,
           LabsActionPlans__Campaign__c,
           LabsActionPlans__Case__c,
           LabsActionPlans__Contact__c,
           LabsActionPlans__Contract__c,
           LabsActionPlans__Lead__c,
           LabsActionPlans__Opportunity__c,
           CreatedDate,
           LastModifiedDate
    FROM LabsActionPlans__ActionPlan__c
    WHERE LabsActionPlans__Action_Plan_Template__c IN :lapt
    AND LabsActionPlans__TaskRecordTypeID__c != '012VC000002mfNtYAI'
];

System.debug('Total Action Plans to analyze: ' + actionPlans.size());

// Prepare for update
for(LabsActionPlans__ActionPlan__c ap : actionPlans) {
    ap.LabsActionPlans__TaskRecordTypeID__c = '012VC000002mfNtYAI';
}

// Attempt update with detailed error tracking
Database.SaveResult[] results = Database.update(actionPlans, false);

Integer successCount = 0;
Integer failCount = 0;
Map<String, Integer> errorTypeCounts = new Map<String, Integer>();
Map<String, List<String>> errorTypeToIds = new Map<String, List<String>>();

// Create CSV content
String csvContent = 'ActionPlanId,ActionPlanName,Template,CreatedDate,RelatedObjectCount,Account,Campaign,Case,Contact,Contract,Lead,Opportunity,ErrorMessage,StatusCode\n';

for(Integer i = 0; i < results.size(); i++) {
    if(results[i].isSuccess()) {
        successCount++;
    } else {
        failCount++;
        LabsActionPlans__ActionPlan__c failedAP = actionPlans[i];
        
        // Count relationships
        Integer relatedCount = 0;
        if(failedAP.LabsActionPlans__Account__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Campaign__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Case__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Contact__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Contract__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Lead__c != null) relatedCount++;
        if(failedAP.LabsActionPlans__Opportunity__c != null) relatedCount++;
        
        String errorMsg = '';
        String statusCode = '';
        for(Database.Error err : results[i].getErrors()) {
            errorMsg = err.getMessage().replace(',', ';').replace('"', '""').replace('\n', ' ');
            statusCode = String.valueOf(err.getStatusCode());
            
            // Track error types
            String errorKey = String.valueOf(err.getStatusCode()) + ': RelCount=' + relatedCount;
            if(!errorTypeCounts.containsKey(errorKey)) {
                errorTypeCounts.put(errorKey, 0);
                errorTypeToIds.put(errorKey, new List<String>());
            }
            errorTypeCounts.put(errorKey, errorTypeCounts.get(errorKey) + 1);
            errorTypeToIds.get(errorKey).add(String.valueOf(failedAP.Id));
        }
        
        // Build CSV line manually to avoid String.join issues with IDs
        String csvLine = String.valueOf(failedAP.Id) + ',';
        csvLine += '"' + (failedAP.Name != null ? failedAP.Name.replace('"', '""') : '') + '",';
        csvLine += '"' + (failedAP.LabsActionPlans__Action_Plan_Template__r.Name != null ? failedAP.LabsActionPlans__Action_Plan_Template__r.Name.replace('"', '""') : '') + '",';
        csvLine += String.valueOf(failedAP.CreatedDate) + ',';
        csvLine += String.valueOf(relatedCount) + ',';
        csvLine += (failedAP.LabsActionPlans__Account__c != null ? String.valueOf(failedAP.LabsActionPlans__Account__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Campaign__c != null ? String.valueOf(failedAP.LabsActionPlans__Campaign__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Case__c != null ? String.valueOf(failedAP.LabsActionPlans__Case__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Contact__c != null ? String.valueOf(failedAP.LabsActionPlans__Contact__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Contract__c != null ? String.valueOf(failedAP.LabsActionPlans__Contract__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Lead__c != null ? String.valueOf(failedAP.LabsActionPlans__Lead__c) : '') + ',';
        csvLine += (failedAP.LabsActionPlans__Opportunity__c != null ? String.valueOf(failedAP.LabsActionPlans__Opportunity__c) : '') + ',';
        csvLine += '"' + errorMsg + '",';
        csvLine += statusCode + '\n';
        
        csvContent += csvLine;
    }
}

// Create summary email body (short and sweet)
String emailBody = 'ACTION PLAN UPDATE RESULTS\n';
emailBody += '=========================\n\n';
emailBody += 'Total Processed: ' + actionPlans.size() + '\n';
emailBody += 'Successful: ' + successCount + '\n';
emailBody += 'Failed: ' + failCount + '\n\n';

emailBody += 'ERROR TYPE BREAKDOWN:\n';
emailBody += '---------------------\n';
for(String errorType : errorTypeCounts.keySet()) {
    emailBody += errorType + ': ' + errorTypeCounts.get(errorType) + ' occurrences\n';
    List<String> sampleIds = errorTypeToIds.get(errorType);
    Integer sampleSize = Math.min(5, sampleIds.size());
    String sampleIdsList = '';
    for(Integer idx = 0; idx < sampleSize; idx++) {
        if(idx > 0) sampleIdsList += ', ';
        sampleIdsList += sampleIds[idx];
    }
    emailBody += '  Sample IDs: ' + sampleIdsList;
    if(sampleIds.size() > 5) {
        emailBody += '... (and ' + (sampleIds.size() - 5) + ' more)';
    }
    emailBody += '\n\n';
}

emailBody += '\nSee attached CSV file for complete details of all ' + failCount + ' failures.\n';
emailBody += 'You can open this in Excel to filter, sort, and analyze the data.\n';

// Create CSV attachment
Messaging.EmailFileAttachment csvAttachment = new Messaging.EmailFileAttachment();
csvAttachment.setFileName('ActionPlan_Failures_' + System.now().format('yyyy-MM-dd_HHmm') + '.csv');
csvAttachment.setBody(Blob.valueOf(csvContent));
csvAttachment.setContentType('text/csv');

// Send email
Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
email.setToAddresses(new String[]{'spencer.stierhoff@benefitsallin.com'});
email.setSubject('Action Plan Update Results - ' + successCount + ' Success, ' + failCount + ' Failed');
email.setPlainTextBody(emailBody);
email.setFileAttachments(new Messaging.EmailFileAttachment[]{csvAttachment});

try {
    Messaging.sendEmail(new Messaging.SingleEmailMessage[]{email});
    System.debug('Email sent successfully to spencer.stierhoff@benefitsallin.com');
} catch(Exception e) {
    System.debug('Email send failed: ' + e.getMessage());
    System.debug('CSV size in bytes: ' + csvContent.length());
}

System.debug('Summary: Success=' + successCount + ', Failed=' + failCount);
